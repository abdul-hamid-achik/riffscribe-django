{% extends 'transcriber/base.html' %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Header -->
    <div class="flex items-center justify-between mb-8">
        <h1 class="text-3xl font-bold">{{ transcription.filename }}</h1>
        <button hx-delete="{% url 'transcriber:delete' pk=transcription.pk %}"
                hx-confirm="Are you sure you want to delete this transcription?"
                hx-redirect="{% url 'transcriber:index' %}"
                class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition">
            Delete
        </button>
    </div>
    
    <!-- Status Card -->
    <div class="bg-gray-800 rounded-lg p-6 mb-6"
         id="status-card"
         {% if transcription.status in 'pending,processing' %}
         hx-get="{% url 'transcriber:status' pk=transcription.pk %}"
         hx-trigger="every 2s"
         hx-swap="outerHTML"
         {% endif %}>
        
        <div class="grid md:grid-cols-2 gap-6">
            <!-- Left Column -->
            <div>
                <h2 class="text-xl font-semibold mb-4">Transcription Status</h2>
                
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <span class="text-gray-400">Status:</span>
                        <span class="px-3 py-1 rounded-full text-sm font-semibold
                            {% if transcription.status == 'completed' %}bg-green-900 text-green-300
                            {% elif transcription.status == 'processing' %}bg-yellow-900 text-yellow-300
                            {% elif transcription.status == 'failed' %}bg-red-900 text-red-300
                            {% else %}bg-gray-700 text-gray-300{% endif %}">
                            {{ transcription.get_status_display }}
                        </span>
                    </div>
                    
                    {% if transcription.status == 'processing' %}
                    <div class="mt-4">
                        <div class="flex items-center space-x-2">
                            <svg class="animate-spin h-5 w-5 text-purple-500" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span class="text-gray-300">Processing audio...</span>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if transcription.error_message %}
                    <div class="mt-4 p-4 bg-red-900 bg-opacity-30 rounded-lg">
                        <p class="text-red-300">{{ transcription.error_message }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Right Column -->
            <div>
                <h2 class="text-xl font-semibold mb-4">Audio Analysis</h2>
                
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <span class="text-gray-400">Duration:</span>
                        <span class="text-gray-200">{{ transcription.duration_formatted }}</span>
                    </div>
                    
                    {% if transcription.estimated_tempo %}
                    <div class="flex items-center justify-between">
                        <span class="text-gray-400">Tempo:</span>
                        <span class="text-gray-200">{{ transcription.estimated_tempo }} BPM</span>
                    </div>
                    {% endif %}
                    
                    {% if transcription.estimated_key %}
                    <div class="flex items-center justify-between">
                        <span class="text-gray-400">Key:</span>
                        <span class="text-gray-200">{{ transcription.estimated_key }}</span>
                    </div>
                    {% endif %}
                    
                    {% if transcription.complexity %}
                    <div class="flex items-center justify-between">
                        <span class="text-gray-400">Complexity:</span>
                        <span class="text-gray-200">{{ transcription.get_complexity_display }}</span>
                    </div>
                    {% endif %}
                    
                    {% if transcription.detected_instruments %}
                    <div class="flex items-center justify-between">
                        <span class="text-gray-400">Instruments:</span>
                        <span class="text-gray-200">{{ transcription.instruments_display }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Export Options (only show if completed) -->
    {% if transcription.status == 'completed' %}
    <div class="bg-gray-800 rounded-lg p-6 mb-6">
        <h2 class="text-xl font-semibold mb-4">Export Options</h2>
        
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <form hx-post="{% url 'transcriber:export' pk=transcription.pk %}"
                  hx-target="#export-results"
                  hx-swap="beforeend">
                {% csrf_token %}
                <input type="hidden" name="format" value="musicxml">
                <button type="submit" class="w-full px-4 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg transition">
                    <svg class="w-6 h-6 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    MusicXML
                </button>
            </form>
            
            <form hx-post="{% url 'transcriber:export' pk=transcription.pk %}"
                  hx-target="#export-results"
                  hx-swap="beforeend">
                {% csrf_token %}
                <input type="hidden" name="format" value="gp5">
                <button type="submit" class="w-full px-4 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg transition">
                    <svg class="w-6 h-6 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2"></path>
                    </svg>
                    Guitar Pro
                </button>
            </form>
            
            <form hx-post="{% url 'transcriber:export' pk=transcription.pk %}"
                  hx-target="#export-results"
                  hx-swap="beforeend">
                {% csrf_token %}
                <input type="hidden" name="format" value="pdf">
                <button type="submit" class="w-full px-4 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg transition">
                    <svg class="w-6 h-6 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                    </svg>
                    PDF
                </button>
            </form>
            
            <form hx-post="{% url 'transcriber:export' pk=transcription.pk %}"
                  hx-target="#export-results"
                  hx-swap="beforeend">
                {% csrf_token %}
                <input type="hidden" name="format" value="ascii">
                <button type="submit" class="w-full px-4 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg transition">
                    <svg class="w-6 h-6 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
                    </svg>
                    ASCII Tab
                </button>
            </form>
        </div>
        
        <div id="export-results" class="mt-4 space-y-2">
            {% for export in exports %}
            <div class="flex items-center justify-between p-3 bg-gray-700 rounded-lg">
                <span>{{ export.get_format_display }}</span>
                <a href="{% url 'transcriber:download' pk=transcription.pk export_id=export.id %}"
                   class="px-3 py-1 bg-purple-600 hover:bg-purple-700 rounded text-sm">
                    Download
                </a>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Tab Preview (placeholder for now) -->
    <div class="bg-gray-800 rounded-lg p-6">
        <h2 class="text-xl font-semibold mb-4">Tab Preview</h2>
        <div class="bg-gray-900 p-4 rounded-lg font-mono text-sm">
            <pre class="text-gray-300">
e|-----------------------------------|
B|-----------------------------------|
G|---0---2---4---2---0---------------|
D|-----------------------2---0-------|
A|-------------------------------3---|
E|-----------------------------------|
            </pre>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}