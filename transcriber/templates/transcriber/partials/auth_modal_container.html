<!-- Authentication Modal Container (hidden by default) -->
<div id="auth-modal-container"></div>

<script>
// Authentication modal functions
function closeAuthModal(event) {
    // Close modal if clicking backdrop or close button
    if (event && event.target !== event.currentTarget && !event.target.closest('button[onclick*="closeAuthModal"]')) {
        return;
    }
    
    const modal = document.getElementById('auth-modal');
    if (modal) {
        modal.remove();
    }
}

function showAuthModal(type, customMessage) {
    // First check if modal already exists
    let modal = document.getElementById('auth-modal');
    
    if (!modal) {
        // Create modal structure
        const modalHTML = `
            <div id="auth-modal" 
                 class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
                 onclick="closeAuthModal(event)">
                
                <!-- Modal Content -->
                <div class="bg-white rounded-lg shadow-xl max-w-md w-full m-4 transform transition-all">
                    <!-- Modal Header -->
                    <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
                        <h2 id="modal-title" class="text-xl font-semibold text-gray-900">
                            Sign in to your account
                        </h2>
                        <button type="button" 
                                onclick="closeAuthModal()"
                                class="text-gray-400 hover:text-gray-600 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Custom Message (if provided) -->
                    <div id="custom-message" class="px-6 py-3 bg-gradient-to-r from-musical-gold/10 to-musical-treble/10 border-b border-musical-gold/20" style="display: none;">
                        <div class="flex items-center gap-2">
                            <span class="text-lg">‚≠ê</span>
                            <p id="custom-message-text" class="text-sm text-gray-700 font-medium"></p>
                        </div>
                    </div>
                    
                    <!-- Modal Body -->
                    <div id="modal-body" class="px-6 py-6">
                        <!-- Loading spinner -->
                        <div class="flex items-center justify-center py-8">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        const container = document.getElementById('auth-modal-container');
        container.innerHTML = modalHTML;
        modal = document.getElementById('auth-modal');
    }
    
    const modalTitle = document.getElementById('modal-title');
    const modalBody = document.getElementById('modal-body');
    const customMessageDiv = document.getElementById('custom-message');
    const customMessageText = document.getElementById('custom-message-text');
    
    // Show custom message if provided
    if (customMessage) {
        customMessageText.textContent = customMessage;
        customMessageDiv.style.display = 'block';
    } else {
        customMessageDiv.style.display = 'none';
    }
    
    let title, url;
    switch(type) {
        case 'signup':
            title = 'Create your account';
            url = "{% url 'transcriber:auth_modal_signup' %}";
            break;
        case 'forgot':
            title = 'Reset your password';
            url = "{% url 'transcriber:auth_modal_forgot' %}";
            break;
        default:
            title = 'Sign in to your account';
            url = "{% url 'transcriber:auth_modal_signin' %}";
    }
    
    modalTitle.textContent = title;
    
    // Load new content
    htmx.ajax('GET', url, {
        target: '#modal-body',
        swap: 'innerHTML'
    });
}

// Handle successful authentication
document.body.addEventListener('authSuccess', function() {
    closeAuthModal();
    // Optionally refresh the page or trigger the original action
    location.reload();
});

// Close modal on escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape' && document.getElementById('auth-modal')) {
        closeAuthModal();
    }
});
</script>