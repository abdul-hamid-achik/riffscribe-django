<!-- Enhanced Audio Player with WaveSurfer.js and Practice Features -->
<div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden"
    x-data="enhancedAudioPlayer('{{ transcription.original_audio.url }}', '{{ transcription.pk }}')"
    x-init="initializePlayer()">

    <!-- Player Header -->
    <div class="bg-gradient-to-r from-musical-gold to-musical-treble text-white p-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                        <path
                            d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z" />
                    </svg>
                </div>
                <div>
                    <h4 class="font-headline font-semibold">{{ transcription.filename|truncatechars:40 }}</h4>
                    <div class="flex items-center text-sm opacity-90 space-x-3">
                        <span>{{ transcription.estimated_tempo|default:"120" }} BPM</span>
                        <span>•</span>
                        <span>{{ transcription.estimated_key|default:"Unknown" }}</span>
                        <span>•</span>
                        <span>{{ transcription.duration_formatted }}</span>
                    </div>
                </div>
            </div>

            <!-- Practice Mode Toggle -->
            <button @click="togglePracticeMode()" :class="practiceMode ? 'bg-white/30' : 'bg-white/10'"
                class="px-3 py-1.5 rounded-lg text-sm font-medium transition-colors hover:bg-white/20">
                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                </svg>
                Practice Mode
            </button>
        </div>
    </div>

    <!-- Waveform Container -->
    <div class="relative bg-gray-50 p-4">
        <!-- Loading State -->
        <div x-show="!playerReady" class="flex items-center justify-center h-24">
            <div class="text-center">
                <svg class="w-8 h-8 animate-spin text-musical-gold mx-auto mb-2" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" />
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z" />
                </svg>
                <p class="text-sm text-gray-600">Loading waveform...</p>
            </div>
        </div>

        <!-- WaveSurfer Container -->
        <div id="waveform-{{ transcription.pk }}" x-show="playerReady" class="w-full transition-all duration-200"
            :class="practiceMode ? 'h-32' : 'h-20'">
        </div>

        <!-- A-B Loop Markers (Practice Mode Only) -->
        <div x-show="practiceMode && playerReady"
            class="absolute bottom-2 left-4 right-4 flex justify-between text-xs text-gray-500">
            <span x-show="loopStart !== null" class="bg-green-500 text-white px-2 py-1 rounded">
                A: <span x-text="formatTime(loopStart)"></span>
            </span>
            <span x-show="loopEnd !== null" class="bg-red-500 text-white px-2 py-1 rounded">
                B: <span x-text="formatTime(loopEnd)"></span>
            </span>
        </div>
    </div>

    <!-- Main Controls -->
    <div class="p-4 border-t border-gray-100">
        <div class="flex items-center justify-between mb-4">

            <!-- Play Controls -->
            <div class="flex items-center space-x-3">
                <!-- Skip Back -->
                <button @click="skipBack()" :disabled="!playerReady"
                    class="w-10 h-10 bg-gray-100 hover:bg-gray-200 disabled:opacity-50 rounded-full flex items-center justify-center transition-colors">
                    <svg class="w-5 h-5 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                        <path
                            d="M8.445 14.832A1 1 0 0010 14v-2.798l5.445 3.63A1 1 0 0017 14V6a1 1 0 00-1.555-.832L10 8.798V6a1 1 0 00-1.555-.832l-6 4a1 1 0 000 1.664l6 4z" />
                    </svg>
                </button>

                <!-- Main Play/Pause -->
                <button @click="togglePlay()" :disabled="!playerReady"
                    class="w-16 h-16 bg-musical-gold hover:bg-musical-treble disabled:opacity-50 rounded-full flex items-center justify-center transition-all shadow-lg hover:shadow-xl">
                    <svg x-show="!isPlaying" class="w-8 h-8 text-white ml-0.5" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" />
                    </svg>
                    <svg x-show="isPlaying" class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path
                            d="M5.5 3.5A1.5 1.5 0 017 2h6a1.5 1.5 0 011.5 1.5v13A1.5 1.5 0 0113 18H7a1.5 1.5 0 01-1.5-1.5v-13z" />
                    </svg>
                </button>

                <!-- Skip Forward -->
                <button @click="skipForward()" :disabled="!playerReady"
                    class="w-10 h-10 bg-gray-100 hover:bg-gray-200 disabled:opacity-50 rounded-full flex items-center justify-center transition-colors">
                    <svg class="w-5 h-5 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                        <path
                            d="M4.555 5.168A1 1 0 003 6v8a1 1 0 001.555.832L10 11.202V14a1 1 0 001.555.832l6-4a1 1 0 000-1.664l-6-4A1 1 0 0010 6v2.798l-5.445-3.63z" />
                    </svg>
                </button>
            </div>

            <!-- Time Display -->
            <div class="text-center">
                <div class="text-2xl font-mono font-bold text-nyt-black">
                    <span x-text="formatTime(currentTime)">0:00</span>
                    <span class="text-gray-400">/</span>
                    <span x-text="formatTime(duration)" class="text-gray-600">{{
                        transcription.duration_formatted|default:"3:04" }}</span>
                </div>
                <div x-show="playbackRate !== 1" class="text-xs text-musical-gold font-medium">
                    <span x-text="playbackRate">1</span>x speed
                </div>
            </div>

            <!-- Volume Control -->
            <div class="flex items-center space-x-2">
                <svg class="w-5 h-5 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                    <path
                        d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM12.293 7.293a1 1 0 011.414 0L15 8.586l1.293-1.293a1 1 0 111.414 1.414L16.414 10l1.293 1.293a1 1 0 01-1.414 1.414L15 11.414l-1.293 1.293a1 1 0 01-1.414-1.414L13.586 10l-1.293-1.293a1 1 0 010-1.414z" />
                </svg>
                <input type="range" x-model="volume" @input="setVolume()" min="0" max="100"
                    class="w-20 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider">
                <span class="text-sm text-gray-600 w-8" x-text="volume"></span>
            </div>
        </div>

        <!-- Practice Controls (Show when Practice Mode is active) -->
        <div x-show="practiceMode" x-transition:enter="transition ease-out duration-200"
            x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100"
            x-transition:leave="transition ease-in duration-150" x-transition:leave-start="opacity-100 scale-100"
            x-transition:leave-end="opacity-0 scale-95" class="border-t border-gray-100 pt-4 mt-4">

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">

                <!-- A-B Loop Controls -->
                <div class="space-y-2">
                    <label class="text-sm font-medium text-gray-700">Loop Section</label>
                    <div class="flex space-x-2">
                        <button @click="setLoopStart()"
                            :class="loopStart !== null ? 'bg-green-500 text-white' : 'bg-gray-100 text-gray-700'"
                            class="flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-colors">
                            Set A
                        </button>
                        <button @click="setLoopEnd()"
                            :class="loopEnd !== null ? 'bg-red-500 text-white' : 'bg-gray-100 text-gray-700'"
                            class="flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-colors">
                            Set B
                        </button>
                        <button @click="toggleLoop()"
                            :class="isLooping ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-700'"
                            class="flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-colors">
                            Loop
                        </button>
                    </div>
                    <button @click="clearLoop()"
                        class="w-full px-3 py-1 bg-gray-50 text-gray-600 rounded text-xs hover:bg-gray-100 transition-colors">
                        Clear Loop
                    </button>
                </div>

                <!-- Speed Control -->
                <div class="space-y-2">
                    <label class="text-sm font-medium text-gray-700">Practice Speed</label>
                    <select x-model="playbackRate" @change="setPlaybackRate()"
                        class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-musical-gold focus:border-transparent">
                        <option value="0.25">0.25x - Super Slow</option>
                        <option value="0.5">0.5x - Half Speed</option>
                        <option value="0.75">0.75x - Slow</option>
                        <option value="1" selected>1x - Normal</option>
                        <option value="1.25">1.25x - Fast</option>
                        <option value="1.5">1.5x - Faster</option>
                        <option value="2">2x - Double Speed</option>
                    </select>
                    <div class="flex space-x-1">
                        <button @click="changeSpeed(-0.1)"
                            class="flex-1 px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs hover:bg-gray-200 transition-colors">
                            -0.1x
                        </button>
                        <button @click="resetSpeed()"
                            class="flex-1 px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs hover:bg-gray-200 transition-colors">
                            Reset
                        </button>
                        <button @click="changeSpeed(0.1)"
                            class="flex-1 px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs hover:bg-gray-200 transition-colors">
                            +0.1x
                        </button>
                    </div>
                </div>

                <!-- Practice Tools -->
                <div class="space-y-2">
                    <label class="text-sm font-medium text-gray-700">Practice Tools</label>
                    <div class="space-y-2">
                        <button @click="toggleMetronome()"
                            :class="metronomeActive ? 'bg-musical-gold text-white' : 'bg-gray-100 text-gray-700'"
                            class="w-full px-3 py-2 rounded-lg text-sm font-medium transition-colors">
                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            Metronome
                        </button>
                        <button @click="toggleCountIn()"
                            :class="countInEnabled ? 'bg-musical-gold text-white' : 'bg-gray-100 text-gray-700'"
                            class="w-full px-3 py-2 rounded-lg text-sm font-medium transition-colors">
                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M7 4V2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 011 1v4a1 1 0 01-1 1H8a1 1 0 01-1-1V5a1 1 0 011-1zM7 10h4v6a1 1 0 01-1 1H8a1 1 0 01-1-1v-6z" />
                            </svg>
                            Count-In
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile-Optimized Controls (Hidden on desktop) -->
    <div class="md:hidden bg-gray-50 p-4 border-t border-gray-100">
        <div class="flex justify-center space-x-8">
            <button @click="skipBack()" class="p-3 bg-white rounded-full shadow-md">
                <svg class="w-6 h-6 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                    <path
                        d="M8.445 14.832A1 1 0 0010 14v-2.798l5.445 3.63A1 1 0 0017 14V6a1 1 0 00-1.555-.832L10 8.798V6a1 1 0 00-1.555-.832l-6 4a1 1 0 000 1.664l6 4z" />
                </svg>
            </button>
            <button @click="togglePlay()" class="p-4 bg-musical-gold rounded-full shadow-lg">
                <svg x-show="!isPlaying" class="w-8 h-8 text-white ml-0.5" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" />
                </svg>
                <svg x-show="isPlaying" class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
                    <path
                        d="M5.5 3.5A1.5 1.5 0 017 2h6a1.5 1.5 0 011.5 1.5v13A1.5 1.5 0 0113 18H7a1.5 1.5 0 01-1.5-1.5v-13z" />
                </svg>
            </button>
            <button @click="skipForward()" class="p-3 bg-white rounded-full shadow-md">
                <svg class="w-6 h-6 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                    <path
                        d="M4.555 5.168A1 1 0 003 6v8a1 1 0 001.555.832L10 11.202V14a1 1 0 001.555.832l6-4a1 1 0 000-1.664l-6-4A1 1 0 0010 6v2.798l-5.445-3.63z" />
                </svg>
            </button>
        </div>
    </div>
</div>

<!-- WaveSurfer.js -->
<script src="https://unpkg.com/wavesurfer.js@7.7.6/dist/wavesurfer.min.js"></script>

<script>
    function enhancedAudioPlayer(audioUrl, transcriptionId) {
        return {
            // Player state
            wavesurfer: null,
            playerReady: false,
            isPlaying: false,
            currentTime: 0,
            duration: 0,
            volume: 80,

            // Practice mode state
            practiceMode: false,
            playbackRate: 1,
            loopStart: null,
            loopEnd: null,
            isLooping: false,
            metronomeActive: false,
            countInEnabled: false,

            initializePlayer() {
                // Initialize WaveSurfer
                this.wavesurfer = WaveSurfer.create({
                    container: `#waveform-${transcriptionId}`,
                    waveColor: '#c9a96e',
                    progressColor: '#8b4513',
                    cursorColor: '#326891',
                    barWidth: 2,
                    barRadius: 3,
                    responsive: true,
                    height: 80,
                    normalize: true,
                    backend: 'WebAudio',
                    mediaControls: false,
                });

                // Load audio
                this.wavesurfer.load(audioUrl);

                // Event listeners
                this.wavesurfer.on('ready', () => {
                    this.playerReady = true;
                    this.duration = this.wavesurfer.getDuration();
                    this.setVolume();
                });

                this.wavesurfer.on('audioprocess', (time) => {
                    this.currentTime = time;
                    this.checkLoop();
                });

                this.wavesurfer.on('play', () => {
                    this.isPlaying = true;
                });

                this.wavesurfer.on('pause', () => {
                    this.isPlaying = false;
                });

                this.wavesurfer.on('finish', () => {
                    this.isPlaying = false;
                    if (this.isLooping && this.loopStart !== null) {
                        this.wavesurfer.seekTo(this.loopStart / this.duration);
                        this.wavesurfer.play();
                    }
                });
            },

            // Basic controls
            togglePlay() {
                if (!this.playerReady) return;
                this.wavesurfer.playPause();
            },

            skipBack() {
                if (!this.playerReady) return;
                const newTime = Math.max(0, this.currentTime - 10);
                this.wavesurfer.seekTo(newTime / this.duration);
            },

            skipForward() {
                if (!this.playerReady) return;
                const newTime = Math.min(this.duration, this.currentTime + 10);
                this.wavesurfer.seekTo(newTime / this.duration);
            },

            setVolume() {
                if (!this.playerReady) return;
                this.wavesurfer.setVolume(this.volume / 100);
            },

            // Practice mode
            togglePracticeMode() {
                this.practiceMode = !this.practiceMode;
                if (this.practiceMode) {
                    // Switch to higher resolution waveform for practice
                    this.wavesurfer.params.height = 120;
                } else {
                    this.wavesurfer.params.height = 80;
                    this.clearLoop();
                }
            },

            // A-B Loop functionality
            setLoopStart() {
                if (!this.playerReady) return;
                this.loopStart = this.currentTime;
            },

            setLoopEnd() {
                if (!this.playerReady) return;
                this.loopEnd = this.currentTime;
            },

            toggleLoop() {
                if (this.loopStart === null || this.loopEnd === null) return;
                this.isLooping = !this.isLooping;
                if (this.isLooping) {
                    // Jump to loop start
                    this.wavesurfer.seekTo(this.loopStart / this.duration);
                }
            },

            clearLoop() {
                this.loopStart = null;
                this.loopEnd = null;
                this.isLooping = false;
            },

            checkLoop() {
                if (this.isLooping && this.loopStart !== null && this.loopEnd !== null) {
                    if (this.currentTime >= this.loopEnd) {
                        this.wavesurfer.seekTo(this.loopStart / this.duration);
                    }
                }
            },

            // Speed controls
            setPlaybackRate() {
                if (!this.playerReady) return;
                this.wavesurfer.setPlaybackRate(this.playbackRate);
            },

            changeSpeed(delta) {
                const newRate = Math.max(0.25, Math.min(2, this.playbackRate + delta));
                this.playbackRate = Math.round(newRate * 10) / 10; // Round to 1 decimal
                this.setPlaybackRate();
            },

            resetSpeed() {
                this.playbackRate = 1;
                this.setPlaybackRate();
            },

            // Practice tools
            toggleMetronome() {
                this.metronomeActive = !this.metronomeActive;
                // TODO: Implement metronome functionality
            },

            toggleCountIn() {
                this.countInEnabled = !this.countInEnabled;
                // TODO: Implement count-in functionality
            },

            // Utility functions
            formatTime(seconds) {
                if (!seconds || seconds === Infinity || isNaN(seconds)) return '0:00';
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }
        }
    }
</script>

<!-- Custom slider styles for volume control -->
<style>
    .slider::-webkit-slider-thumb {
        appearance: none;
        height: 16px;
        width: 16px;
        border-radius: 50%;
        background: #c9a96e;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .slider::-moz-range-thumb {
        height: 16px;
        width: 16px;
        border-radius: 50%;
        background: #c9a96e;
        cursor: pointer;
        border: none;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .slider::-webkit-slider-track {
        height: 8px;
        border-radius: 4px;
        background: #e5e7eb;
    }

    .slider::-moz-range-track {
        height: 8px;
        border-radius: 4px;
        background: #e5e7eb;
        border: none;
    }
</style>