<!-- Base Modal Component -->
<div id="modal-overlay" 
     class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 opacity-0"
     style="display: none;"
     onclick="closeModal(event)">
    
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 transform scale-95 transition-all duration-200 ease-out"
         onclick="event.stopPropagation()"
         id="modal-content">
        
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-6 border-b border-gray-200">
            <h2 class="text-xl font-bold text-gray-900" id="modal-title">
                <!-- Title will be set by specific modals -->
            </h2>
            <button type="button" 
                    onclick="closeModal()"
                    class="text-gray-400 hover:text-gray-600 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        
        <!-- Modal Body -->
        <div class="p-6" id="modal-body">
            <!-- Content will be loaded here -->
        </div>
    </div>
</div>

<script>
let currentModal = null;

function showModal(title, contentHtml, options = {}) {
    const overlay = document.getElementById('modal-overlay');
    const titleEl = document.getElementById('modal-title');
    const bodyEl = document.getElementById('modal-body');
    const contentEl = document.getElementById('modal-content');
    
    // Set content
    titleEl.textContent = title;
    bodyEl.innerHTML = contentHtml;
    
    // Apply size options
    if (options.size === 'large') {
        contentEl.classList.remove('max-w-md');
        contentEl.classList.add('max-w-2xl');
    } else if (options.size === 'small') {
        contentEl.classList.remove('max-w-md');
        contentEl.classList.add('max-w-sm');
    }
    
    // Show modal with animation
    overlay.style.display = 'flex';
    setTimeout(() => {
        overlay.classList.remove('opacity-0');
        overlay.classList.add('opacity-100');
        contentEl.classList.remove('scale-95');
        contentEl.classList.add('scale-100');
    }, 10);
    
    currentModal = overlay;
    
    // Prevent body scroll
    document.body.style.overflow = 'hidden';
}

function closeModal(event) {
    if (event && event.target !== event.currentTarget && !event.target.closest('[data-close-modal]')) {
        return;
    }
    
    const overlay = document.getElementById('modal-overlay');
    const contentEl = document.getElementById('modal-content');
    
    // Hide with animation
    overlay.classList.remove('opacity-100');
    overlay.classList.add('opacity-0');
    contentEl.classList.remove('scale-100');
    contentEl.classList.add('scale-95');
    
    setTimeout(() => {
        overlay.style.display = 'none';
        // Reset size classes
        contentEl.classList.remove('max-w-2xl', 'max-w-sm');
        contentEl.classList.add('max-w-md');
    }, 200);
    
    currentModal = null;
    
    // Restore body scroll
    document.body.style.overflow = '';
}

// Close modal on Escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape' && currentModal) {
        closeModal();
    }
});

// HTMX modal helpers
function showAuthModal(type = 'signin') {
    const title = type === 'signin' ? 'Sign in to your account' : 'Create your account';
    
    // Fetch the auth form via HTMX
    htmx.ajax('GET', `/accounts/modal/${type}/`, {
        target: '#modal-body',
        swap: 'innerHTML'
    }).then(() => {
        document.getElementById('modal-title').textContent = title;
        const overlay = document.getElementById('modal-overlay');
        const contentEl = document.getElementById('modal-content');
        
        overlay.style.display = 'flex';
        setTimeout(() => {
            overlay.classList.remove('opacity-0');
            overlay.classList.add('opacity-100');
            contentEl.classList.remove('scale-95');
            contentEl.classList.add('scale-100');
        }, 10);
        
        currentModal = overlay;
        document.body.style.overflow = 'hidden';
    });
}

// Handle successful auth - close modal and refresh page
document.body.addEventListener('authSuccess', function() {
    closeModal();
    // Optionally refresh the page or update the UI
    setTimeout(() => {
        window.location.reload();
    }, 300);
});
</script>